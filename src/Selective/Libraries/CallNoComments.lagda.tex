\begin{code}
module Selective.Libraries.CallNoComments where

open import Selective.ActorMonad
open import Prelude

open SelectedMessage

UniqueTag = ℕ

call-select-unwrap : ∀ {MtIn MT} {IS : InboxShape} →
                        UniqueTag →
                        MT ∈ IS →
                        All receive-field-content MT →
                        (ValueType UniqueTag ∷ MtIn) ∈ IS →
                        Bool
call-select-unwrap tag Z (tag' ∷ fs) Z = ⌊ tag ≟ tag' ⌋
call-select-unwrap _ Z _ (S p) = false
call-select-unwrap _ (S x) _ Z = false
call-select-unwrap tag (S x) fs (S p) = call-select-unwrap tag x fs p

call-select : ∀ {IS IS' MtIn} →
                UniqueTag →
                IS' <: IS →
                (ValueType UniqueTag ∷ MtIn) ∈ IS' →
                MessageFilter IS
call-select {IS} tag sub which (Msg x fs) =
  call-select-unwrap tag x fs (translate-⊆  sub which)

call : {Γ : TypingContext} {i : Size}
        {MtTo MtIn : MessageType}
        {To IS IS' : InboxShape} →
        (Γ ⊢ To) →
        ((ValueType UniqueTag ∷ ReferenceType IS' ∷ MtTo) ∈ To) →
        (tag : UniqueTag) →
        All (send-field-content Γ) MtTo →
        (ISsubs : IS' <: IS) →
        (whichIn : (ValueType UniqueTag ∷ MtIn) ∈ IS') →
        ∞ActorM i IS
          (SelectedMessage (call-select tag ISsubs whichIn))
          Γ (add-selected-references Γ)
call {Γ} {IS = IS} var toFi tag vals sub whichIn =
  do
      self
      S var ![t: toFi ] ((lift tag) ∷ ([ Z ]>: sub) ∷ (translate-fields vals))
      strengthen (⊆-suc ⊆-refl)
      selective-receive (call-select tag sub whichIn)
  where
    translate-fields : ∀ {MT} →
                        All (send-field-content Γ) MT →
                        All (send-field-content (IS ∷ Γ)) MT
    translate-fields [] = []
    translate-fields {ValueType x ∷ MT} (px ∷ vals) =
      px ∷ (translate-fields vals)
    translate-fields {ReferenceType x ∷ MT} (([ p ]>: v) ∷ vals) =
      ([ (S p) ]>: v) ∷ (translate-fields vals)

AddReplyMessage : MessageType
AddReplyMessage = ValueType UniqueTag ∷ [ ValueType ℕ ]ˡ

AddReply : InboxShape
AddReply = [ AddReplyMessage ]ˡ

AddMessage : MessageType
AddMessage = ValueType UniqueTag ∷ ReferenceType AddReply ∷ ValueType ℕ ∷ [ ValueType ℕ ]ˡ

Calculator : InboxShape
Calculator = [ AddMessage ]ˡ

calculatorActor : ∀ {i} → ∞ActorM (↑ i) Calculator (Lift ⊤) [] (λ _ → [])
calculatorActor .force = receive ∞>>= λ {
  (Msg Z (tag ∷ _ ∷ n ∷ m ∷ [])) .force →
    (Z ![t: Z ] (lift tag ∷ [ lift (n + m) ]ᵃ)) ∞>> (do
    strengthen []
    calculatorActor)
  ; (Msg (S ()) _)
  }

TestBox : InboxShape
TestBox = AddReply

calltestActor : ∀{i} → ∞ActorM i TestBox (Lift ℕ) [] (λ _ → [])
calltestActor .force = spawn∞ calculatorActor ∞>> do
    x ← call Z Z 0
          ((lift 10) ∷ [ lift 32 ]ᵃ)
          ⊆-refl Z
    strengthen []
    return-result x
  where
    return-result : SelectedMessage {TestBox} (call-select 0 [ Z ]ᵐ Z) →
                    ∀ {i} → ∞ActorM i TestBox (Lift ℕ) [] (λ _ → [])
    return-result record { msg = (Msg Z (tag ∷ n ∷ [])) } = return n
    return-result record { msg = (Msg (S x) x₁) ; msg-ok = () }

\end{code}
